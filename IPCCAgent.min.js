!function(e,t,o){var n=t.SmileSoft=t.SmileSoft||function(){var e={},t=e.hasOwnProperty;return{on:function(o,n){t.call(e,o)||(e[o]=[]);var s=e[o].push(n)-1;return{off:function(){delete e[o][s]}}},emit:function(o,n){t.call(e,o)&&e[o].forEach(function(e){e(void 0!==n?n:{})})}}}();n[e]=o(e,n)}("Agent",this,function(e,t){"use strict";function o(o,n){t.on(e+"."+y[o],n)}function n(o,n){t.emit(e+"."+y[o],n)}function s(e,t){var o=Object.create(e);return Object.keys(t).map(function(e){e in o&&(o[e]=t[e])}),o}function r(e){var t=1e3*(Math.pow(2,e)-1);return t>3e4&&(t=3e4),Math.random()*t}function c(e,t){5===e?(0!==t.state&&1!==t.state&&6!==t.state&&8!==t.state&&S.getProcess(),h(t)):7==e&&b(t)}function a(){m=setInterval(function(){S.getState()},k.updateInterval)}function i(){console.log("Websocket opened"),n("ready"),S.getState()}function u(t){var o=JSON.parse(t.data),s=o.method;if(console.log("onWebsocketMessage data: ",o),o.error&&n("Error",{module:e,error:o.error}),o.method){var r=o.params;"setProcess"==s?b(r):"setState"==s&&h(r)}else o.id&&c(o.id,o.result)}function l(){if(console.log("Websocket closed"),k.websockets){var e=r(M);setTimeout(function(){M++,d()},e)}}function f(t){n("Error",{module:e,error:t})}function d(){if(k.websockets){if(!window.WebSocket)return console.log("WebSocket is not supported. Please update your browser."),console.log("Fallback to XMLHttpRequest"),k.websockets=!1,d();console.log("Switched to Websockets"),void 0!==m&&clearInterval(m),v=new WebSocket(("https"===P?"wss":"ws")+"://"+k.server+"/","json.api.smile-soft.com"),v.onopen=i,v.onmessage=u,v.onclose=l,v.onerror=f}else void 0!==v&&v.close(),console.log("Switched to XMLHttpRequest"),a(),n("ready")}function p(){return window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")}function g(t,o,s){var r,c,a,i={},u=null;i.method=t,o&&(i.params=o),"number"==typeof s&&(i.id=s),i=JSON.stringify(i),k.websockets?v.send(i):(r=p(),r.open("POST",P+"://"+k.server+"/",!0),a=setTimeout(function(){r.abort()},3e4),r.onreadystatechange=function(){4==r.readyState&&(clearTimeout(a),r.response&&(c=JSON.parse(r.response),c.error&&(u=c.error,n("Error",{module:e,error:u})),s&&s(c.result)))},r.setRequestHeader("Content-Type","application/json; charset=UTF-8"),r.send(i))}function h(e){n("statechange",e)}function b(e){n("processchange",e)}function w(t){return t&&(k=s(k,t)),O?console.log("Module "+e+" already initiated, do nothing"):(d(),O=!0,S)}var m,v,S,k={server:window.location.host,websockets:!0,updateInterval:1e3,bubble:!0},y={ready:"ready",processchange:"processchange",statechange:"statechange"},P=-1!==window.location.protocol.indexOf("https")?"https":"http",M=1,O=!1,T="";return S={init:w,process:{},state:null,substate:null,on:o,emit:n,getProcess:function(){g("getProcess",null,k.websockets?7:b)},getState:function(){g("getState",null,k.websockets?5:h)},call:function(e){g("initCall",{number:e})},answer:function(){g("answerCall")},hold:function(){g("pressHold")},idle:function(){1===S.state||6===S.state?g("setPauseState",{state:0}):console.log("Not in WRAP or PAUSE, do nothing.")},conference:function(){g("pressConference")},drop:function(){g("dropCall")},close:function(e,t){return T="",e||(T+="processid is not defined\n"),t||(T+="exitcode is not defined\n"),""!==T?console.error("Can't close process:\n"+T):void g("closeProcess",{processid:e,exitcode:t})},pause:function(e,t){g("setPauseState",{state:e,comment:t||""})}},o("statechange",function(e){S.state=e.state,S.substate=e.substate}),o("processchange",function(e){S.process=e}),w});