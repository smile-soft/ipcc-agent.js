!function(e,t,o){var n=t.SmileSoft=t.SmileSoft||function(){var e={},t=e.hasOwnProperty;return{on:function(o,n){t.call(e,o)||(e[o]=[]);var s=e[o].push(n)-1;return{off:function(){delete e[o][s]}}},emit:function(o,n){t.call(e,o)&&e[o].forEach(function(e){e(void 0!==n?n:{})})}}}();n[e]=o(e,n)}("Agent",this,function(e,t){"use strict";function o(o,n){t.on(e+"."+M[o],n)}function n(o,n){t.emit(e+"."+M[o],n)}function s(e,t){var o=Object.create(e);return Object.keys(t).map(function(e){e in o&&(o[e]=t[e])}),o}function r(e){var t=1e3*(Math.pow(2,e)-1);return t>3e4&&(t=3e4),Math.random()*t}function c(e,t){5===e?(0!==t.state&&1!==t.state&&6!==t.state&&8!==t.state&&b(),g(t)):7==e&&m(t)}function a(){S=setInterval(function(){w()},P.updateInterval)}function i(){console.log("Websocket opened"),n("ready"),w()}function u(t){var o=JSON.parse(t.data),s=o.method;if(console.log("onWebsocketMessage data: ",o),o.error&&n("Error",{module:e,error:o.error}),o.method){var r=o.params;"setProcess"==s?m(r):"setState"==s&&g(r)}else o.id&&c(o.id,o.result)}function l(){if(console.log("Websocket closed"),P.websockets){var e=r(T);setTimeout(function(){T++,d()},e)}}function f(t){n("Error",{module:e,error:t})}function d(){if(P.websockets){if(!window.WebSocket)return console.log("WebSocket is not supported. Please update your browser."),console.log("Fallback to XMLHttpRequest"),P.websockets=!1,d();console.log("Switched to Websockets"),void 0!==S&&clearInterval(S),k=new WebSocket(("https"===O?"wss":"ws")+"://"+P.server+"/","json.api.smile-soft.com"),k.onopen=i,k.onmessage=u,k.onclose=l,k.onerror=f}else void 0!==k&&k.close(),console.log("Switched to XMLHttpRequest"),a(),n("ready")}function p(){return window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")}function h(t,o,s){var r,c,a,i={},u=null;i.method=t,o&&(i.params=o),"number"==typeof s&&(i.id=s),i=JSON.stringify(i),P.websockets?k.send(i):(r=p(),r.open("POST",O+"://"+P.server+"/",!0),a=setTimeout(function(){r.abort()},3e4),r.onreadystatechange=function(){4==r.readyState&&(clearTimeout(a),r.response&&(c=JSON.parse(r.response),c.error&&(u=c.error,n("Error",{module:e,error:u})),s&&s(c.result)))},r.setRequestHeader("Content-Type","application/json; charset=UTF-8"),r.send(i))}function b(){h("getProcess",null,P.websockets?7:m)}function w(){h("getState",null,P.websockets?5:g)}function g(e){n("statechange",e)}function m(e){n("processchange",e)}function v(t){return t&&(P=s(P,t)),W?console.log("Module "+e+" already initiated, do nothing"):(d(),W=!0,y)}var S,k,y,P={server:window.location.host,websockets:!0,updateInterval:1e3,bubble:!0},M={ready:"ready",processchange:"processchange",statechange:"statechange"},O=-1!==window.location.protocol.indexOf("https")?"https":"http",T=1,W=!1,H="";return y={process:{},state:null,substate:null,on:o,emit:n,call:function(e){h("initCall",{number:e})},answer:function(){h("answerCall")},hold:function(){h("pressHold")},idle:function(){1===y.state||6===y.state?h("setPauseState",{state:0}):console.log("Not in WRAP or PAUSE, do nothing.")},conference:function(){h("pressConference")},drop:function(){h("dropCall")},close:function(e,t){return H="",e||(H+="processid is not defined\n"),t||(H+="exitcode is not defined\n"),""!==H?console.error("Can't close process:\n"+H):void h("closeProcess",{processid:e,exitcode:t})},pause:function(e,t){h("setPauseState",{state:e,comment:t||""})}},o("statechange",function(e){y.state=e.state,y.substate=e.substate}),o("processchange",function(e){y.process=e}),v});