!function(e,t,o){var n=t.SmileSoft=t.SmileSoft||function(){var e={},t=e.hasOwnProperty;return{on:function(o,n){t.call(e,o)||(e[o]=[]);var s=e[o].push(n)-1;return{remove:function(){delete e[o][s]}}},emit:function(o,n){t.call(e,o)&&e[o].forEach(function(e){e(void 0!=n?n:{})})}}}();n[e]=o(e,n)}("Agent",this,function(e,t){"use strict";function o(o,n){t.on(e+"."+M[o],function(e){n(e)})}function n(o,n){t.emit(e+"."+M[o],n)}function s(e,t){var o=Object.create(e);return Object.keys(t).map(function(e){e in o&&(o[e]=t[e])}),o}function r(e){var t=1e3*(Math.pow(2,e)-1);return t>3e4&&(t=3e4),Math.random()*t}function c(e,t){5===e?(0!==t.state&&1!==t.state&&6!==t.state&&8!==t.state&&S.getProcess(),g(t)):7==e&&h(t)}function a(){b=setInterval(function(){S.getState()},k.updateInterval)}function i(){console.log("Websocket opened"),n("moduleInitiated"),S.getState()}function u(o){var n=JSON.parse(o.data),s=n.method;if(console.log("onWebsocketMessage data: ",n),n.error&&t.emit("Error",{module:e,error:n.error}),n.method){var r=n.params;"setProcess"==s?h(r):"setState"==s&&g(r)}else n.id&&c(n.id,n.result)}function l(){if(console.log("Websocket closed"),k.websockets){var e=r(y);setTimeout(function(){y++,d()},e)}}function f(o){t.emit("Error",{module:e,error:o})}function d(){if(k.websockets){if(!window.WebSocket)return console.log("WebSocket is not supported. Please update your browser."),console.log("Fallback to XMLHttpRequest"),k.websockets=!1,d();console.log("Switched to Websockets"),void 0!==b&&clearInterval(b),v=new WebSocket(("https"===P?"wss":"ws")+"://"+k.server+"/","json.api.smile-soft.com"),v.onopen=i,v.onmessage=u,v.onclose=l,v.onerror=f}else void 0!==v&&v.close(),console.log("Switched to XMLHttpRequest"),a(),n("moduleInitiated")}function p(){return window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")}function m(o,n,s){var r,c,a,i={},u=null;i.method=o,n&&(i.params=n),"number"==typeof s&&(i.id=s),i=JSON.stringify(i),k.websockets?v.send(i):(r=p(),r.open("POST",P+"://"+k.server+"/",!0),a=setTimeout(function(){r.abort()},3e4),r.onreadystatechange=function(){4==r.readyState&&(clearTimeout(a),r.response&&(c=JSON.parse(r.response),c.error&&(u=c.error,t.emit("Error",{module:e,error:u})),s&&s(c.result)))},r.setRequestHeader("Content-Type","application/json; charset=UTF-8"),r.send(i))}function g(e){n("stateChange",e)}function h(e){n("processChange",e)}function w(t){return t&&(k=s(k,t)),C?console.log("Module "+e+" already initiated, do nothing"):(d(),C=!0,S)}var b,v,S,k={server:window.location.host,websockets:!0,updateInterval:1e3},M={moduleInitiated:"moduleInitiated",processChange:"processchange",stateChange:"statechange"},P=-1!==window.location.protocol.indexOf("https")?"https":"http",y=1,C=!1;return S={process:{},state:null,substate:null,getProcess:function(){m("getProcess",null,k.websockets?7:h)},getState:function(){m("getState",null,k.websockets?5:g)},call:function(e){m("initCall",{number:e})},answer:function(){m("answerCall")},hold:function(){m("pressHold")},conference:function(){m("pressConference")},drop:function(){m("dropCall")},close:function(e,t){m("closeProcess",{processid:e,exitcode:t})},pause:function(e,t){m("setPauseState",{state:e,comment:t||""})}},o("statechange",function(e){S.state=e.state,S.substate=e.substate}),o("processchange",function(e){S.process=e}),w});